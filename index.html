<html>
<head>
<title>Daff - diff tabular data in javascript</title>
<script src="lib/jquery.min.js"></script>
<script src="dist/jquery.handsontable.full.js"></script>
<script src="daff.js"></script>
<script src="daff_handsontable.js"></script>
<script src="test_data.js"></script>
<link rel="stylesheet" media="screen" href="dist/jquery.handsontable.full.css">
<link rel="stylesheet" media="screen" href="daff.css">
<link rel="stylesheet" media="screen" href="daff_handsontable.css">
</head>

<body>

<a href="https://github.com/paulfitz/daff"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png" alt="Fork me on GitHub"></a>

<div class="top-info">

  <h1>daff</h1>

  <p class="explain">
  This is a library for comparing tables and incorporating changes.
  Edit the examples below to see it live. It is available for
  javascript, ruby, python, php, and other languages on <a href="https://github.com/paulfitz/daff">github</a>.
  </p>


<div id="controls">
  <a href="#" id="control-item-config" class="control-item control-menu" data-item="item-config"><b>&equiv;</b></a>
  <a href="#" id="control-item-parent" class="control-item" data-item="item-parent" style="display: none;">Ancestor</a>
  <a href="#" id="control-item-before" class="control-item" data-item="item-before">Original table</a>
  <a href="#" id="control-item-after" class="control-item" data-item="item-after">Modified table</a>
  <a href="#" id="control-item-diff" class="control-item" data-item="item-diff">Difference</a>
</div>

</div>

<div id="main">

<div id="items">

  <div id="item-config" class="item">
    <form class="demo-options">
      <span class="unit"><input id="parent_checkbox" type="checkbox" /><label for="parent_checkbox">Use 3-way comparison</label></span>
    <span class="unit"><input id="order_checkbox" type="checkbox" /><label for="order_checkbox">Show row/column numbers</label></span>
      <span class="unit"><input type=button id="button-clear" value="clear all cells" /></span>
    </form>
  </div>

  <div id="item-parent" class="item">
    <div id="table0" class="tabular"></div>
    <div class="explain">
      You can edit this table. The <a class="show-item" data-item="item-diff" href="#">difference</a> will be recalculated immediately.  This table should be a common ancestor for the <a class="show-item" data-item="item-before" href="#">&ldquo;original&rdquo; table</a> and the <a class="show-item" data-item="item-after" href="#">modified table</a>.
    </div>
  </div>
  
  <div id="item-before" class="item">
    <div id="table1" class="tabular"></div>
    <div class="explain">
      You can edit this table. The <a class="show-item" data-item="item-diff" href="#">difference</a> will be recalculated immediately.  We are using this as the original version of the table.  The difference will show the changes that were made in the <a class="show-item" data-item="item-after" href="#">modified table</a>.
    </div>
  </div>
  <div id="item-after" class="item">
    <div id="table2" class="tabular"></div>
    <div class="explain">
      You can edit this table. The <a class="show-item" data-item="item-diff" href="#">difference</a> will be recalculated immediately.  The difference will show the changes that were made in this table with respect to the <a class="show-item" data-item="item-before" href="#">original table</a>.
    </div>
  </div>
  <div id="item-diff" class="item">
    <div id="diff" class="highlighter tabular"></div>
    <div class="explain">
      <p>This shows the changes made in the <a class="show-item" data-item="item-after" href="#">modified table</a> with respect to the <a class="show-item" data-item="item-before" href="#">original table</a>.  The format used is the <a href="http://dataprotocols.org/tabular-diff-format/">highlighter tabular diff</a>.</p>
      <p>You can collapse the diff down to nothing by
      <a href="#" id="apply-diff">applying it to the original table</a>.
      More usefully, you can edit the diff first before applying it.  Erasing
      cells like &ldquo;<span class="plus">+++</span>&rdquo; or 
      &ldquo;<span class="minus">---</span>&rdquo; means those changes won't get applied.
      </p>
      
    </div>
  </div>
</div>
</div>

<table id="pane-collection">

  <tr>
    <td id="table-pane">
      <div class="pane-show">
	<div id="block1">
	</div>
	<div id="block2">
	</div>
      </div>
    </td>
    
    <td id="result-pane">
      <div class="pane-show">
    </td>
  </tr>

</table>


<script>
$(function() {

   function showItem(name) {
     $(".item").each(function() {
       $(this).hide();
     });
     $("#" + name).show();
     $(".control-item").each(function() {
       $(this).removeClass('control-item-active');
     });
     $("#control-" + name).addClass('control-item-active');
     $("#control-" + name).removeClass('control-item-mod');
   }

   function flagItem(name) {
     if (!$("#control-" + name).hasClass('control-item-active')) {
       $("#control-" + name).addClass('control-item-mod');
     }
   }

   $(".control-item").each(function() {
     var self = $(this);
     self.click(function() {
       showItem(self.data("item"));
       return false;
     });
   });
   $(".show-item").each(function() {
     var self = $(this);
     self.click(function() {
       showItem(self.data("item"));
       return false;
     });
   });
   showItem("item-diff");

   function load_table(t,data) {
     t.length = 0;
     for (var i=0; i < data.length; i++) {
       t[i] = data[i].slice();
     }
   }

   var use_parent = false;
   var show_order = false;
   function processChange(changes,source,table) {
     if (source=="loadData") return;
     var t1 = new daff.TableView(data1);
     var t2 = new daff.TableView(data2);
     t1.trim();
     t2.trim();
     var ct = null;
     if (!use_parent) { 
       ct = daff.compareTables(t1,t2);
     } else {
       var t0 = new daff.TableView(data0);
       t0.trim();
       ct = daff.compareTables3(t0,t1,t2);
     }
     var align = ct.align();
     var output = new daff.TableView([]);
     var flags = new daff.CompareFlags();
     flags.show_unchanged = false;
     flags.always_show_header = true;
     if (show_order) {
       flags.never_show_order = false;
       flags.always_show_order = true;
     }
     (new daff.TableDiff(align,flags)).hilite(output);
     data_diff = output.data;
     $("#diff").handsontable('loadData',output.data);
     flagItem("item-diff");
   }

   var data_diff =  [
     [ "" ]
   ];

   var example = all_examples[0];

   var data0 = [];
   var data1 = [];
   var data2 = [];
   load_table(data0,example["parent"]);
   load_table(data1,example["local"]);
   load_table(data2,example["remote"]);

   function headerPromptRenderer(instance, td, row, col, prop, value, cellProperties) {
     Handsontable.TextCell.renderer.apply(this, arguments);
     if (row==0) {
       td.className = 'header';
     }
   }

   $('#table0').handsontable({
     data: data0,
     minRows: 5,
     minCols: 6,
     minSpareRows: 1,
     autoWrapRow: true,
     colHeaders: false,
     contextMenu: true,
     height: 200,
     asyncRendering: false,
     onChange: function(changes,source) { processChange(changes,source,'table1'); },
     cells: function (row, col, prop) {
       var cellProperties = {};
       cellProperties.type = {
	 renderer: headerPromptRenderer
       }
       return cellProperties;
     }
   });

   $('#table1').handsontable({
     data: data1,
     minRows: 5,
     minCols: 6,
     minSpareRows: 1,
     autoWrapRow: true,
     colHeaders: false,
     contextMenu: true,
     height: 200,
     asyncRendering: false,
     onChange: function(changes,source) { processChange(changes,source,'table1'); },
     cells: function (row, col, prop) {
       var cellProperties = {};
       cellProperties.type = {
	 renderer: headerPromptRenderer
       }
       return cellProperties;
     }
   });

   $('#table2').handsontable({
     data: data2,
     minRows: 5,
     minCols: 6,
     minSpareRows: 1,
     autoWrapRow: true,
     colHeaders: false,
     contextMenu: true,
     height: 200,
     asyncRendering: false,
     onChange: function(changes,source) { processChange(changes,source,'table2'); },
     cells: function (row, col, prop) {
       var cellProperties = {};
       cellProperties.type = {
	 renderer: headerPromptRenderer
       }
       return cellProperties;
     }
   });

   $('#diff').handsontable({
     data: data_diff,
     minRows: 1,
     minCols: 1,
     minSpareCols: 0,
     minSpareRows: 0,
     autoWrapRow: true,
     colHeaders: false,
     //contextMenu: true,
     //height: 300,
     asyncRendering: false,
     cells: function (row, col, prop) {
       var cellProperties = {};
       cellProperties.type = {
	 renderer: daff.diffRenderer
       }
       return cellProperties;
     }
   });
   processChange(null,null,null);

   $("#parent_checkbox").click(function() {
     use_parent = $("#parent_checkbox")[0].checked;
     if (use_parent) {
       $("#control-item-parent").show();
     } else {
       $("#control-item-parent").hide();
       $("#item-parent").hide();
     }
     processChange(null,null,null);
     flagItem("item-parent");
     return true;
   });

   $("#order_checkbox").click(function() {
     show_order = $("#order_checkbox")[0].checked;
     processChange(null,null,null);
     return true;
   });

   function clear_table(t) {
     t.length = 0;
     t[0] = ["A","B","C"];
     t[1] = ["","",""];
     t[2] = ["","",""];
   }

   $("#button-clear").click(function() {
     clear_table(data0);
     clear_table(data1);
     clear_table(data2);
     $('#table0').handsontable('render');
     $('#table1').handsontable('render');
     $('#table2').handsontable('render');
     processChange(null,null,null);
     flagItem("item-before");
     flagItem("item-after");
     flagItem("item-parent");
     return false;
   });

   $("#apply-diff").click(function() {
     var t1 = new daff.TableView(data1);
     t1.trim();
     var patch = new daff.TableView(data_diff);
     patch.trim();
     var patcher = new daff.HighlightPatch(t1,patch);
     patcher.apply();
     if (use_parent) {
       var t1 = new daff.TableView(data0);
       t1.trim();
       var patch = new daff.TableView(data_diff);
       patch.trim();
       var patcher = new daff.HighlightPatch(t1,patch);
       patcher.apply();
       $('#table0').handsontable('render');
     }
     $('#table1').handsontable('render');
     processChange(null,null,null);
     flagItem("item-before");
     return false;
   });

   for (var i=0; i < all_examples.length; i++) {
     var example = all_examples[i];
     var id = "set_example_" + example["key"];
     $(".demo-options").append("<span class='unit example'><input type=button id='" + id + "' value='" + example["key"] + " example' /></span>");
     $("#" + id).click((function(example,id) { return function() {
       load_table(data0,example["parent"]);
       load_table(data1,example["local"]);
       load_table(data2,example["remote"]);
       $('#table0').handsontable('render');
       $('#table1').handsontable('render');
       $('#table2').handsontable('render');
       processChange(null,null,null);
       showItem("item-diff");
       flagItem("item-before");
       flagItem("item-after");
       flagItem("item-parent");
       return false; 
     }})(example,id));
   }
});

</script>

</body>
</html>
